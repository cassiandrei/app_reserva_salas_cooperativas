{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ object }} - Calend√°rio{% endblock %}

{% block content %}

    <div class="row mt-3">
        <div id="timegrid"></div>
    </div>


{% endblock %}

{% block extra_js %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.global.js"></script>
    <script>
        function formatarHora(dateObj) {
            return dateObj?.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            iniciarCalendario();
        });

        function iniciarCalendario() {

            var calendarEl = document.getElementById("timegrid");
            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: "pt-BR",
                initialView: "timeGridWeek",
                slotMinTime: "{{ slotMinTime }}",
                slotMaxTime: "{{ slotMaxTime }}",
                slotLabelFormat: {
                    hour: "2-digit", // Use 2-digit format for hours (e.g., "01", "02", ..., "12")
                    minute: "2-digit", // Use 2-digit format for minutes (e.g., "00", "15", "30", "45")
                    omitZeroMinute: false, // Keep minutes with leading zero (e.g., "01:00" instead of "1:00")
                    hour12: false, // Use 24-hour format (e.g., "00:00" to "23:00")
                },
                allDaySlot: false,
                events: {{ reservas|safe }},
            });

            function onSelect(arg) {
                try {
                    const reservas = calendar.getEvents();
                    let start = null;
                    let end = null;
                    for (const reserva of reservas) {
                        if (
                            start === null &&
                            reserva.start <= arg.start &&
                            arg.start <= reserva.end
                        ) {
                            // incrementa um minuto
                            start = new Date(reserva.end.getTime() + 60000);
                        }
                        if (
                            end === null &&
                            reserva.start <= arg.end &&
                            arg.end <= reserva.end
                        ) {
                            // decrementa um minuto
                            end = new Date(reserva.start.getTime() - 60000);
                        }
                    }
                    if (end === null) {
                        end = arg.end;
                    }
                    if (start === null) {
                        start = arg.start;
                    }
                    if (end > start) {
                        document.getElementById(
                            "id_horario_inicio"
                        ).value = start.toLocaleTimeString();
                        console.log("abriria o modal");
                        // document
                        $("#cadastro").modal("show");
                    }
                } catch (e) {
                    console.log("erro ao abrir modal ", e);
                }
            }

            calendar.render();
        }

    </script>
{% endblock %}




